# ğŸ” ç½‘å…³é‰´æƒè®¾è®¡æ–¹æ¡ˆ

> **è®¾è®¡æ—¶é—´**ï¼š2025-01-31  
> **é€‚ç”¨ç‰ˆæœ¬**ï¼šCEX v1.0.0

---

## ğŸ“‹ ç›®å½•

1. [è®¾è®¡æ¦‚è¿°](#è®¾è®¡æ¦‚è¿°)
2. [æŠ€æœ¯æ–¹æ¡ˆ](#æŠ€æœ¯æ–¹æ¡ˆ)
3. [ç™½åå•è®¾è®¡](#ç™½åå•è®¾è®¡)
4. [JWTé‰´æƒæµç¨‹](#jwté‰´æƒæµç¨‹)
5. [é»‘åå•æœºåˆ¶](#é»‘åå•æœºåˆ¶)
6. [åˆ·æ–°Tokenç­–ç•¥](#åˆ·æ–°tokenç­–ç•¥)
7. [å®ç°ä»£ç ](#å®ç°ä»£ç )
8. [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)

---

## ğŸ¯ è®¾è®¡æ¦‚è¿°

### è®¾è®¡ç›®æ ‡

1. **ç»Ÿä¸€é‰´æƒå…¥å£**ï¼šåœ¨ç½‘å…³å±‚ç»Ÿä¸€å¤„ç†æ‰€æœ‰è¯·æ±‚çš„é‰´æƒ
2. **ç™½åå•æœºåˆ¶**ï¼šæ”¯æŒå…¬å¼€æ¥å£æ— éœ€é‰´æƒ
3. **JWTéªŒè¯**ï¼šéªŒè¯Tokenæœ‰æ•ˆæ€§ã€è¿‡æœŸæ—¶é—´ã€é»‘åå•
4. **ç”¨æˆ·ä¿¡æ¯ä¼ é€’**ï¼šå°†ç”¨æˆ·ä¿¡æ¯é€šè¿‡è¯·æ±‚å¤´ä¼ é€’ç»™ä¸‹æ¸¸æœåŠ¡
5. **é«˜æ€§èƒ½**ï¼šä½¿ç”¨Redisç¼“å­˜é»‘åå•ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢

### æ¶æ„å›¾

```
å®¢æˆ·ç«¯è¯·æ±‚
    â†“
Gateway (é‰´æƒè¿‡æ»¤å™¨)
    â”œâ”€ ç™½åå•æ£€æŸ¥ â†’ ç›´æ¥æ”¾è¡Œ âœ…
    â””â”€ éœ€è¦é‰´æƒ
        â”œâ”€ æå–Token
        â”œâ”€ éªŒè¯Tokenæœ‰æ•ˆæ€§
        â”œâ”€ æ£€æŸ¥é»‘åå•ï¼ˆRedisï¼‰
        â”œâ”€ è§£æç”¨æˆ·ä¿¡æ¯
        â””â”€ æ·»åŠ è¯·æ±‚å¤´ â†’ ä¸‹æ¸¸æœåŠ¡ âœ…
```

---

## ğŸ”§ æŠ€æœ¯æ–¹æ¡ˆ

### 1. ä½¿ç”¨Spring Cloud Gateway GlobalFilter

- **ä¼˜ç‚¹**ï¼š
  - ç»Ÿä¸€å¤„ç†æ‰€æœ‰è¯·æ±‚
  - æ”¯æŒå¼‚æ­¥éé˜»å¡
  - å¯ä»¥ä¿®æ”¹è¯·æ±‚å’Œå“åº”

### 2. JWT TokenéªŒè¯

- **Tokenæ ¼å¼**ï¼š`Bearer <token>`
- **Tokenä½ç½®**ï¼š`Authorization` è¯·æ±‚å¤´
- **éªŒè¯å†…å®¹**ï¼š
  - ç­¾åéªŒè¯
  - è¿‡æœŸæ—¶é—´éªŒè¯
  - é»‘åå•æ£€æŸ¥

### 3. Redisé»‘åå•

- **Keyæ ¼å¼**ï¼š`jwt:blacklist:<token>`
- **TTL**ï¼šä¸Tokenè¿‡æœŸæ—¶é—´ä¸€è‡´
- **ä½œç”¨**ï¼šæ”¯æŒç™»å‡ºã€å¼ºåˆ¶ä¸‹çº¿

---

## ğŸ“ ç™½åå•è®¾è®¡

### ç™½åå•è·¯å¾„åˆ—è¡¨

#### 1. ç”¨æˆ·æœåŠ¡ï¼ˆcex-userï¼‰

```yaml
# æ³¨å†Œç™»å½•ç›¸å…³ï¼ˆæ— éœ€é‰´æƒï¼‰
- /api/user/login              # ç™»å½•
- /api/user/register           # æ³¨å†Œ
- /api/user/register/mobile    # æ‰‹æœºå·æ³¨å†Œ
- /api/user/register/email     # é‚®ç®±æ³¨å†Œ
- /api/user/captcha            # éªŒè¯ç 
- /api/user/send-sms           # å‘é€çŸ­ä¿¡éªŒè¯ç 
- /api/user/send-email         # å‘é€é‚®ä»¶éªŒè¯ç 
- /api/user/check-username     # æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨
- /api/user/check-mobile       # æ£€æŸ¥æ‰‹æœºå·æ˜¯å¦å­˜åœ¨
- /api/user/check-email        # æ£€æŸ¥é‚®ç®±æ˜¯å¦å­˜åœ¨
- /api/user/forget-password    # å¿˜è®°å¯†ç 
- /api/user/reset-password     # é‡ç½®å¯†ç 

# å…¬å…±ä¿¡æ¯ï¼ˆæ— éœ€é‰´æƒï¼‰
- /api/user/info/public        # å…¬å¼€ç”¨æˆ·ä¿¡æ¯ï¼ˆå¦‚æ¨å¹¿é“¾æ¥ï¼‰
- /api/user/invite/check       # æ£€æŸ¥é‚€è¯·ç æœ‰æ•ˆæ€§
```

#### 2. äº¤æ˜“æœåŠ¡ï¼ˆcex-tradeï¼‰

```yaml
# è¡Œæƒ…æ•°æ®ï¼ˆå…¬å¼€ï¼Œæ— éœ€é‰´æƒï¼‰
- /api/trade/symbol/list       # äº¤æ˜“å¯¹åˆ—è¡¨
- /api/trade/symbol/detail     # äº¤æ˜“å¯¹è¯¦æƒ…
- /api/trade/market/ticker     # è¡Œæƒ…æ•°æ®
- /api/trade/market/depth      # æ·±åº¦æ•°æ®
- /api/trade/market/kline      # Kçº¿æ•°æ®
- /api/trade/market/trades     # æˆäº¤è®°å½•

# éœ€è¦é‰´æƒ
- /api/trade/order/**          # è®¢å•ç›¸å…³ï¼ˆéœ€è¦ç™»å½•ï¼‰
- /api/trade/my/**             # æˆ‘çš„è®¢å•ï¼ˆéœ€è¦ç™»å½•ï¼‰
```

#### 3. é’±åŒ…æœåŠ¡ï¼ˆcex-walletï¼‰

```yaml
# å…¨éƒ¨éœ€è¦é‰´æƒï¼ˆé’±åŒ…æ“ä½œéƒ½éœ€è¦ç™»å½•ï¼‰
# æ— ç™½åå•
```

#### 4. æ´»åŠ¨æœåŠ¡ï¼ˆcex-activityï¼‰

```yaml
# æ´»åŠ¨åˆ—è¡¨ï¼ˆå…¬å¼€ï¼‰
- /api/activity/list            # æ´»åŠ¨åˆ—è¡¨
- /api/activity/detail/**      # æ´»åŠ¨è¯¦æƒ…

# éœ€è¦é‰´æƒ
- /api/activity/sign            # ç­¾åˆ°ï¼ˆéœ€è¦ç™»å½•ï¼‰
- /api/activity/participate     # å‚ä¸æ´»åŠ¨ï¼ˆéœ€è¦ç™»å½•ï¼‰
- /api/activity/redpacket/**    # çº¢åŒ…ç›¸å…³ï¼ˆéœ€è¦ç™»å½•ï¼‰
```

#### 5. é€šçŸ¥æœåŠ¡ï¼ˆcex-notificationï¼‰

```yaml
# å‘é€éªŒè¯ç ï¼ˆæ— éœ€é‰´æƒï¼‰
- /api/notification/sms/send    # å‘é€çŸ­ä¿¡
- /api/notification/email/send # å‘é€é‚®ä»¶

# éœ€è¦é‰´æƒ
- /api/notification/message/**  # ç«™å†…æ¶ˆæ¯ï¼ˆéœ€è¦ç™»å½•ï¼‰
```

#### 6. ç®¡ç†æœåŠ¡ï¼ˆcex-adminï¼‰

```yaml
# ç®¡ç†å‘˜ç™»å½•ï¼ˆæ— éœ€é‰´æƒï¼‰
- /api/admin/login              # ç®¡ç†å‘˜ç™»å½•

# å…¶ä»–å…¨éƒ¨éœ€è¦é‰´æƒï¼ˆç®¡ç†å‘˜æƒé™ï¼‰
- /api/admin/**                 # éœ€è¦ç®¡ç†å‘˜Token
```

#### 7. ç³»ç»Ÿæ¥å£ï¼ˆæ— éœ€é‰´æƒï¼‰

```yaml
# å¥åº·æ£€æŸ¥
- /actuator/**                  # Spring Boot Actuator

# APIæ–‡æ¡£
- /swagger-ui/**                # Swagger UI
- /v3/api-docs/**               # OpenAPIæ–‡æ¡£
```

---

## ğŸ”‘ JWTé‰´æƒæµç¨‹

### æµç¨‹å›¾

```
è¯·æ±‚åˆ°è¾¾ç½‘å…³
    â†“
æ£€æŸ¥ç™½åå•
    â†“
æ˜¯å¦åœ¨ç™½åå•ï¼Ÿ
    â”œâ”€ æ˜¯ â†’ ç›´æ¥æ”¾è¡Œ âœ…
    â””â”€ å¦ â†’ ç»§ç»­é‰´æƒ
        â†“
æå–Authorizationå¤´
    â†“
Tokenæ˜¯å¦å­˜åœ¨ï¼Ÿ
    â”œâ”€ å¦ â†’ è¿”å›401æœªæˆæƒ âŒ
    â””â”€ æ˜¯ â†’ ç»§ç»­éªŒè¯
        â†“
éªŒè¯Tokenæ ¼å¼ï¼ˆBearer <token>ï¼‰
    â†“
æ ¼å¼æ­£ç¡®ï¼Ÿ
    â”œâ”€ å¦ â†’ è¿”å›401æ ¼å¼é”™è¯¯ âŒ
    â””â”€ æ˜¯ â†’ æå–Token
        â†“
éªŒè¯Tokenç­¾å
    â†“
ç­¾åæœ‰æ•ˆï¼Ÿ
    â”œâ”€ å¦ â†’ è¿”å›401ç­¾åæ— æ•ˆ âŒ
    â””â”€ æ˜¯ â†’ æ£€æŸ¥è¿‡æœŸæ—¶é—´
        â†“
Tokenæ˜¯å¦è¿‡æœŸï¼Ÿ
    â”œâ”€ æ˜¯ â†’ è¿”å›401å·²è¿‡æœŸ âŒ
    â””â”€ å¦ â†’ æ£€æŸ¥é»‘åå•
        â†“
Tokenæ˜¯å¦åœ¨é»‘åå•ï¼Ÿ
    â”œâ”€ æ˜¯ â†’ è¿”å›401å·²ç™»å‡º âŒ
    â””â”€ å¦ â†’ è§£æç”¨æˆ·ä¿¡æ¯
        â†“
æ·»åŠ è¯·æ±‚å¤´åˆ°ä¸‹æ¸¸æœåŠ¡
    â”œâ”€ X-User-Id: userId
    â”œâ”€ X-User-Name: username
    â”œâ”€ X-User-Level: level
    â””â”€ X-User-Verified: verified
        â†“
æ”¾è¡Œè¯·æ±‚ âœ…
```

---

## ğŸš« é»‘åå•æœºåˆ¶

### è®¾è®¡ç›®çš„

1. **æ”¯æŒç™»å‡º**ï¼šç”¨æˆ·ç™»å‡ºæ—¶å°†TokenåŠ å…¥é»‘åå•
2. **å¼ºåˆ¶ä¸‹çº¿**ï¼šç®¡ç†å‘˜å¯ä»¥å¼ºåˆ¶ç”¨æˆ·ä¸‹çº¿
3. **Tokenåˆ·æ–°**ï¼šåˆ·æ–°Tokenæ—¶ï¼Œæ—§TokenåŠ å…¥é»‘åå•

### Rediså­˜å‚¨è®¾è®¡

#### Keyè®¾è®¡

```
jwt:blacklist:<token_hash>
```

**è¯´æ˜**ï¼š
- `token_hash`ï¼šä½¿ç”¨SHA-256å¯¹å®Œæ•´Tokenè¿›è¡Œå“ˆå¸Œï¼Œé¿å…Keyè¿‡é•¿
- ä½¿ç”¨å“ˆå¸Œè€Œä¸æ˜¯å®Œæ•´Tokenï¼Œå› ä¸ºTokenå¯èƒ½å¾ˆé•¿

#### Valueè®¾è®¡

```json
{
  "userId": 123,
  "blacklistTime": 1704067200000,
  "reason": "logout"  // logout, refresh, force_logout
}
```

#### TTLè®¾è®¡

- **TTL**ï¼šä¸Tokençš„å‰©ä½™è¿‡æœŸæ—¶é—´ä¸€è‡´
- **åŸå› **ï¼šTokenè¿‡æœŸåï¼Œé»‘åå•è®°å½•è‡ªåŠ¨æ¸…ç†ï¼Œæ— éœ€æ‰‹åŠ¨åˆ é™¤

### é»‘åå•æ£€æŸ¥æµç¨‹

```
1. æå–Token
2. è®¡ç®—Tokenå“ˆå¸Œï¼šSHA256(token)
3. æ„å»ºRedis Keyï¼šjwt:blacklist:<hash>
4. æ£€æŸ¥Redisä¸­æ˜¯å¦å­˜åœ¨
5. å­˜åœ¨ â†’ Tokenå·²å¤±æ•ˆï¼Œè¿”å›401
6. ä¸å­˜åœ¨ â†’ Tokenæœ‰æ•ˆï¼Œç»§ç»­éªŒè¯
```

---

## ğŸ”„ åˆ·æ–°Tokenç­–ç•¥

### ç­–ç•¥é€‰æ‹©ï¼šRefresh Token + Access Token

#### åŒTokenæœºåˆ¶

```
Access Tokenï¼ˆçŸ­æœŸï¼‰ï¼š
- è¿‡æœŸæ—¶é—´ï¼š2å°æ—¶
- ç”¨é€”ï¼šæ—¥å¸¸APIè°ƒç”¨
- å­˜å‚¨ï¼šå†…å­˜ï¼ˆå‰ç«¯ï¼‰

Refresh Tokenï¼ˆé•¿æœŸï¼‰ï¼š
- è¿‡æœŸæ—¶é—´ï¼š7å¤©
- ç”¨é€”ï¼šåˆ·æ–°Access Token
- å­˜å‚¨ï¼šHttpOnly Cookieï¼ˆæ›´å®‰å…¨ï¼‰
```

#### åˆ·æ–°æµç¨‹

```
1. å‰ç«¯æ£€æµ‹åˆ°Access Tokenå³å°†è¿‡æœŸ
2. è°ƒç”¨ /api/user/refresh-token
3. åç«¯éªŒè¯Refresh Token
4. ç”Ÿæˆæ–°çš„Access Tokenå’ŒRefresh Token
5. å°†æ—§Access TokenåŠ å…¥é»‘åå•
6. è¿”å›æ–°Tokenç»™å‰ç«¯
```

### å½“å‰æ–¹æ¡ˆï¼ˆå•Token + æ»‘åŠ¨è¿‡æœŸï¼‰

**å½“å‰å®ç°**ï¼š
- ä½¿ç”¨å•Tokenï¼Œè¿‡æœŸæ—¶é—´7å¤©
- åˆ·æ–°Tokenæ—¶ï¼Œç”Ÿæˆæ–°Tokenï¼Œæ—§TokenåŠ å…¥é»‘åå•

**ä¼˜ç‚¹**ï¼š
- å®ç°ç®€å•
- æ— éœ€ç®¡ç†åŒToken

**ç¼ºç‚¹**ï¼š
- å®‰å…¨æ€§ç¨ä½ï¼ˆTokené•¿æœŸæœ‰æ•ˆï¼‰
- æ— æ³•ç»†ç²’åº¦æ§åˆ¶

**å»ºè®®**ï¼š
- å½“å‰é˜¶æ®µä½¿ç”¨å•Tokenæ–¹æ¡ˆ
- åç»­å¯å‡çº§ä¸ºåŒTokenæ–¹æ¡ˆ

---

## ğŸ’» å®ç°ä»£ç 

### 1. Gatewayä¾èµ–æ·»åŠ 

éœ€è¦åœ¨ `cex-gateway/pom.xml` ä¸­æ·»åŠ ï¼š

```xml
<!-- Redisæ”¯æŒï¼ˆç”¨äºé»‘åå•ï¼‰ -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis-reactive</artifactId>
</dependency>
```

**æ³¨æ„**ï¼šGatewayä½¿ç”¨WebFluxï¼ˆå“åº”å¼ï¼‰ï¼Œéœ€è¦ä½¿ç”¨ `reactive` ç‰ˆæœ¬çš„Redisã€‚

### 2. é‰´æƒè¿‡æ»¤å™¨

åˆ›å»º `AuthGlobalFilter.java`ï¼š

```java
package com.cex.gateway.filter;

import com.cex.common.core.util.JwtUtils;
import io.jsonwebtoken.Claims;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.cloud.gateway.filter.GatewayFilterChain;
import org.springframework.cloud.gateway.filter.GlobalFilter;
import org.springframework.core.Ordered;
import org.springframework.core.io.buffer.DataBuffer;
import org.springframework.data.redis.core.ReactiveRedisTemplate;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.server.reactive.ServerHttpRequest;
import org.springframework.http.server.reactive.ServerHttpResponse;
import org.springframework.stereotype.Component;
import org.springframework.util.AntPathMatcher;
import org.springframework.util.StringUtils;
import org.springframework.web.server.ServerWebExchange;
import reactor.core.publisher.Mono;

import java.nio.charset.StandardCharsets;
import java.security.MessageDigest;
import java.util.Arrays;
import java.util.List;

/**
 * ç½‘å…³å…¨å±€é‰´æƒè¿‡æ»¤å™¨
 * 
 * @author cex
 */
@Slf4j
@Component
public class AuthGlobalFilter implements GlobalFilter, Ordered {

    @Autowired
    private ReactiveRedisTemplate<String, String> redisTemplate;

    /**
     * ç™½åå•è·¯å¾„åˆ—è¡¨
     */
    private static final List<String> WHITE_LIST = Arrays.asList(
        // ç”¨æˆ·æœåŠ¡
        "/api/user/login",
        "/api/user/register",
        "/api/user/register/mobile",
        "/api/user/register/email",
        "/api/user/captcha",
        "/api/user/send-sms",
        "/api/user/send-email",
        "/api/user/check-username",
        "/api/user/check-mobile",
        "/api/user/check-email",
        "/api/user/forget-password",
        "/api/user/reset-password",
        "/api/user/info/public",
        "/api/user/invite/check",
        
        // äº¤æ˜“æœåŠ¡ - è¡Œæƒ…æ•°æ®ï¼ˆå…¬å¼€ï¼‰
        "/api/trade/symbol/list",
        "/api/trade/symbol/detail",
        "/api/trade/market/ticker",
        "/api/trade/market/depth",
        "/api/trade/market/kline",
        "/api/trade/market/trades",
        
        // æ´»åŠ¨æœåŠ¡ - æ´»åŠ¨åˆ—è¡¨
        "/api/activity/list",
        "/api/activity/detail/**",
        
        // é€šçŸ¥æœåŠ¡ - å‘é€éªŒè¯ç 
        "/api/notification/sms/send",
        "/api/notification/email/send",
        
        // ç®¡ç†æœåŠ¡ - ç®¡ç†å‘˜ç™»å½•
        "/api/admin/login",
        
        // ç³»ç»Ÿæ¥å£
        "/actuator/**",
        "/swagger-ui/**",
        "/v3/api-docs/**"
    );

    private final AntPathMatcher pathMatcher = new AntPathMatcher();

    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        ServerHttpRequest request = exchange.getRequest();
        String path = request.getURI().getPath();

        // 1. æ£€æŸ¥ç™½åå•
        if (isWhiteList(path)) {
            log.debug("ç™½åå•è·¯å¾„ï¼Œç›´æ¥æ”¾è¡Œ: {}", path);
            return chain.filter(exchange);
        }

        // 2. æå–Token
        String token = getToken(request);
        if (!StringUtils.hasText(token)) {
            log.warn("è¯·æ±‚ç¼ºå°‘Token: {}", path);
            return unauthorized(exchange, "æœªæˆæƒï¼Œè¯·å…ˆç™»å½•");
        }

        // 3. éªŒè¯Token
        return validateToken(token)
            .flatMap(claims -> {
                // 4. æ£€æŸ¥é»‘åå•
                return checkBlacklist(token)
                    .flatMap(isBlacklisted -> {
                        if (isBlacklisted) {
                            log.warn("Tokenåœ¨é»‘åå•ä¸­: userId={}", claims.get("userId"));
                            return unauthorized(exchange, "Tokenå·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•");
                        }

                        // 5. æ·»åŠ ç”¨æˆ·ä¿¡æ¯åˆ°è¯·æ±‚å¤´
                        ServerHttpRequest modifiedRequest = addUserHeaders(request, claims);
                        ServerWebExchange modifiedExchange = exchange.mutate()
                            .request(modifiedRequest)
                            .build();

                        log.debug("é‰´æƒé€šè¿‡ï¼Œæ”¾è¡Œè¯·æ±‚: path={}, userId={}", path, claims.get("userId"));
                        return chain.filter(modifiedExchange);
                    });
            })
            .onErrorResume(e -> {
                log.error("TokenéªŒè¯å¤±è´¥: {}", e.getMessage());
                return unauthorized(exchange, "TokenéªŒè¯å¤±è´¥: " + e.getMessage());
            });
    }

    /**
     * æ£€æŸ¥è·¯å¾„æ˜¯å¦åœ¨ç™½åå•
     */
    private boolean isWhiteList(String path) {
        return WHITE_LIST.stream()
            .anyMatch(pattern -> pathMatcher.match(pattern, path));
    }

    /**
     * ä»è¯·æ±‚å¤´æå–Token
     */
    private String getToken(ServerHttpRequest request) {
        String authorization = request.getHeaders().getFirst(HttpHeaders.AUTHORIZATION);
        if (StringUtils.hasText(authorization) && authorization.startsWith("Bearer ")) {
            return authorization.substring(7);
        }
        return null;
    }

    /**
     * éªŒè¯Tokenæœ‰æ•ˆæ€§
     */
    private Mono<Claims> validateToken(String token) {
        try {
            if (!JwtUtils.validateToken(token)) {
                return Mono.error(new RuntimeException("Tokenå·²è¿‡æœŸæˆ–æ— æ•ˆ"));
            }
            Claims claims = JwtUtils.getClaimsFromToken(token);
            return Mono.just(claims);
        } catch (Exception e) {
            return Mono.error(new RuntimeException("Tokenè§£æå¤±è´¥: " + e.getMessage()));
        }
    }

    /**
     * æ£€æŸ¥Tokenæ˜¯å¦åœ¨é»‘åå•
     */
    private Mono<Boolean> checkBlacklist(String token) {
        try {
            String tokenHash = sha256(token);
            String key = "jwt:blacklist:" + tokenHash;
            return redisTemplate.hasKey(key)
                .defaultIfEmpty(false);
        } catch (Exception e) {
            log.error("æ£€æŸ¥é»‘åå•å¤±è´¥: {}", e.getMessage());
            // æ£€æŸ¥å¤±è´¥æ—¶ï¼Œä¸ºäº†å®‰å…¨èµ·è§ï¼Œè®¤ä¸ºTokenæ— æ•ˆ
            return Mono.just(true);
        }
    }

    /**
     * æ·»åŠ ç”¨æˆ·ä¿¡æ¯åˆ°è¯·æ±‚å¤´
     */
    private ServerHttpRequest addUserHeaders(ServerHttpRequest request, Claims claims) {
        return request.mutate()
            .header("X-User-Id", String.valueOf(claims.get("userId")))
            .header("X-User-Name", String.valueOf(claims.get("username")))
            .header("X-User-Level", String.valueOf(claims.get("level")))
            .header("X-User-Verified", String.valueOf(claims.get("verified")))
            .build();
    }

    /**
     * è¿”å›401æœªæˆæƒå“åº”
     */
    private Mono<Void> unauthorized(ServerWebExchange exchange, String message) {
        ServerHttpResponse response = exchange.getResponse();
        response.setStatusCode(HttpStatus.UNAUTHORIZED);
        response.getHeaders().add(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE);

        String body = String.format(
            "{\"code\":401,\"message\":\"%s\",\"data\":null}",
            message
        );

        DataBuffer buffer = response.bufferFactory()
            .wrap(body.getBytes(StandardCharsets.UTF_8));
        return response.writeWith(Mono.just(buffer));
    }

    /**
     * SHA-256å“ˆå¸Œ
     */
    private String sha256(String input) {
        try {
            MessageDigest digest = MessageDigest.getInstance("SHA-256");
            byte[] hash = digest.digest(input.getBytes(StandardCharsets.UTF_8));
            StringBuilder hexString = new StringBuilder();
            for (byte b : hash) {
                String hex = Integer.toHexString(0xff & b);
                if (hex.length() == 1) {
                    hexString.append('0');
                }
                hexString.append(hex);
            }
            return hexString.toString();
        } catch (Exception e) {
            throw new RuntimeException("SHA-256è®¡ç®—å¤±è´¥", e);
        }
    }

    @Override
    public int getOrder() {
        // ä¼˜å…ˆçº§ï¼š-100ï¼ˆåœ¨è·¯ç”±ä¹‹å‰æ‰§è¡Œï¼‰
        return -100;
    }
}
```

### 3. Redisé…ç½®

åœ¨ `cex-gateway/src/main/resources/application.yml` ä¸­æ·»åŠ ï¼š

```yaml
spring:
  redis:
    host: localhost
    port: 6379
    password: 123456
    database: 0
    timeout: 3000ms
    lettuce:
      pool:
        max-active: 200
        max-idle: 10
        min-idle: 5
```

### 4. Redisé…ç½®ç±»

åˆ›å»º `RedisConfig.java`ï¼š

```java
package com.cex.gateway.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.redis.connection.RedisConnectionFactory;
import org.springframework.data.redis.core.ReactiveRedisTemplate;
import org.springframework.data.redis.serializer.RedisSerializationContext;
import org.springframework.data.redis.serializer.StringRedisSerializer;

/**
 * Rediså“åº”å¼é…ç½®
 * 
 * @author cex
 */
@Configuration
public class RedisConfig {

    @Bean
    public ReactiveRedisTemplate<String, String> reactiveRedisTemplate(
            RedisConnectionFactory connectionFactory) {
        StringRedisSerializer serializer = new StringRedisSerializer();
        RedisSerializationContext<String, String> serializationContext =
            RedisSerializationContext.<String, String>newSerializationContext()
                .key(serializer)
                .value(serializer)
                .hashKey(serializer)
                .hashValue(serializer)
                .build();
        
        return new ReactiveRedisTemplate<>(connectionFactory, serializationContext);
    }
}
```

---

## ğŸ“‹ é…ç½®è¯´æ˜

### 1. ç™½åå•é…ç½®

ç™½åå•å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶ç®¡ç†ï¼Œæ”¯æŒåŠ¨æ€æ›´æ–°ï¼š

```yaml
gateway:
  auth:
    white-list:
      - /api/user/login
      - /api/user/register
      # ... å…¶ä»–ç™½åå•è·¯å¾„
```

### 2. Tokené…ç½®

```yaml
gateway:
  auth:
    token:
      header-name: Authorization
      prefix: Bearer
      expire-time: 604800000  # 7å¤©ï¼ˆæ¯«ç§’ï¼‰
```

### 3. é»‘åå•é…ç½®

```yaml
gateway:
  auth:
    blacklist:
      redis-key-prefix: jwt:blacklist:
      ttl: 604800000  # ä¸Tokenè¿‡æœŸæ—¶é—´ä¸€è‡´
```

---

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### 1. å‰ç«¯è¯·æ±‚

```javascript
// ç™»å½•åè·å–Token
const token = response.data.token;

// åç»­è¯·æ±‚æºå¸¦Token
fetch('/api/trade/order/place', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(orderData)
});
```

### 2. åç«¯æœåŠ¡è·å–ç”¨æˆ·ä¿¡æ¯

```java
@RestController
@RequestMapping("/api/trade")
public class TradeController {
    
    @GetMapping("/my/orders")
    public Result<List<Order>> getMyOrders(
            @RequestHeader("X-User-Id") Long userId) {
        // ä»è¯·æ±‚å¤´è·å–ç”¨æˆ·ID
        return tradeService.getOrdersByUserId(userId);
    }
}
```

---

## âœ… æ€»ç»“

### å·²å®ŒæˆåŠŸèƒ½

1. âœ… ç½‘å…³å…¨å±€é‰´æƒè¿‡æ»¤å™¨
2. âœ… ç™½åå•æœºåˆ¶
3. âœ… JWT TokenéªŒè¯
4. âœ… Redisé»‘åå•æ£€æŸ¥
5. âœ… ç”¨æˆ·ä¿¡æ¯ä¼ é€’åˆ°ä¸‹æ¸¸æœåŠ¡

### ä¸‹ä¸€æ­¥

1. å®ç°ç™»å‡ºæ¥å£ï¼ˆå°†TokenåŠ å…¥é»‘åå•ï¼‰
2. å®ç°Tokenåˆ·æ–°æ¥å£
3. æ·»åŠ ç®¡ç†å‘˜æƒé™éªŒè¯ï¼ˆç®¡ç†å‘˜Tokenï¼‰
4. æ·»åŠ é™æµè§„åˆ™ï¼ˆSentinelï¼‰

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2025-01-31

